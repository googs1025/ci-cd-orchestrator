# CI/CD 编排器接口测试文档

## 1. 测试环境

- **API 基础 URL**: `http://localhost:8080/api/v1`
- **服务器状态**: 运行中
- **测试项目目录**: `test/`
  - `test/go-project/` (Go 项目)
  - `test/java-project/` (Java 项目)
  - `test/nodejs-project/` (Node.js 项目)
  - `test/python-project/` (Python 项目)

## 2. 接口测试用例

### 2.1 项目管理接口

#### 2.1.1 创建项目
- **请求方法**: POST
- **请求 URL**: `/projects`
- **请求头**: `Content-Type: application/json`
- **请求体**:
  ```json
  {
    "name": "go-project",
    "path": "test/go-project"
  }
  ```
- **预期响应**:
  ```json
  {
    "status": "success",
    "data": {},
    "message": "创建项目成功"
  }
  ```

#### 2.1.2 获取项目列表
- **请求方法**: GET
- **请求 URL**: `/projects`
- **预期响应**:
  ```json
  {
    "status": "success",
    "data": [],
    "message": "获取项目列表成功"
  }
  ```

#### 2.1.3 获取项目详情
- **请求方法**: GET
- **请求 URL**: `/projects/1`
- **预期响应**:
  ```json
  {
    "status": "success",
    "data": {},
    "message": "获取项目详情成功"
  }
  ```

### 2.2 技术栈分析接口

#### 2.2.1 分析项目技术栈
- **请求方法**: POST
- **请求 URL**: `/projects/1/analyze?path=test/go-project`
- **预期响应**:
  ```json
  {
    "status": "success",
    "data": {
      "project_path": "test/go-project",
      "tech_stack": {
        "language": "Go",
        "framework": "",
        "build_tool": "go mod",
        "test_framework": "testing",
        "dependencies": {
          "github.com/gin-gonic/gin": "v1.9.0",
          "go": "1.20"
        },
        "files": []
      },
      "confidence": 0.8,
      "errors": []
    },
    "message": "分析项目技术栈成功"
  }
  ```

#### 2.2.2 获取项目技术栈
- **请求方法**: GET
- **请求 URL**: `/projects/1/tech-stack?path=test/go-project`
- **预期响应**:
  ```json
  {
    "status": "success",
    "data": {
      "language": "Go",
      "framework": "",
      "build_tool": "go mod",
      "test_framework": "testing",
      "dependencies": {
        "github.com/gin-gonic/gin": "v1.9.0",
        "go": "1.20"
      },
      "files": []
    },
    "message": "获取项目技术栈成功"
  }
  ```

### 2.3 CI/CD 管道配置接口

#### 2.3.1 生成管道配置 (GitHub Actions)
- **请求方法**: POST
- **请求 URL**: `/projects/1/generate-pipeline?path=test/go-project&platform=github`
- **预期响应**:
  ```json
  {
    "status": "success",
    "data": {
      "platform": "github_actions",
      "config_type": "yaml",
      "content": "name: CI\n\non:\n  push:\n    branches: [ main ]\n  pull_request:\n    branches: [ main ]\njobs:\n  build:\n    runs-on: ubuntu-latest\n    steps:\n    - uses: actions/checkout@v2\n    - name: Set up Go\n      uses: actions/setup-go@v2\n      with:\n        go-version: 1.20\n    - name: Build\n      run: go build -v ./...\n    - name: Test\n      run: go test -v ./...\n",
      "filename": ".github/workflows/ci.yml"
    },
    "message": "生成管道配置成功"
  }
  ```
- **验证**: 检查 `test/go-project/.github/workflows/ci.yml` 文件是否生成

#### 2.3.2 生成管道配置 (Mock)
- **请求方法**: POST
- **请求 URL**: `/projects/1/generate-pipeline?path=test/go-project&platform=mock`
- **预期响应**:
  ```json
  {
    "status": "success",
    "data": {
      "platform": "mock",
      "config_type": "yaml",
      "content": "name: Mock CI\n\non:\n  push:\n    branches: [ main ]\n\njobs:\n  build:\n    runs-on: mock-runner\n    steps:\n    - name: Mock checkout\n      run: echo \"Mock checkout step\"\n    - name: Mock build\n      run: echo \"Mock build step\"\n    - name: Mock test\n      run: echo \"Mock test step\"\n",
      "filename": "mock-ci.yml"
    },
    "message": "生成管道配置成功"
  }
  ```
- **验证**: 检查 `test/go-project/mock-ci.yml` 文件是否生成

#### 2.3.3 生成管道配置 (文件已存在)
- **请求方法**: POST
- **请求 URL**: `/projects/1/generate-pipeline?path=test/go-project&platform=github`
- **预期响应**:
  ```json
  {
    "status": "success",
    "data": {
      "platform": "github_actions",
      "config_type": "yaml",
      "content": "name: CI\n...",
      "filename": ".github/workflows/ci.yml"
    },
    "message": "配置文件已存在，跳过生成"
  }
  ```

#### 2.3.4 获取管道配置
- **请求方法**: GET
- **请求 URL**: `/projects/1/pipeline`
- **预期响应**:
  ```json
  {
    "status": "success",
    "data": {
      "platform": "github_actions",
      "config_type": "yaml",
      "content": "name: CI\n...",
      "filename": ".github/workflows/ci.yml"
    },
    "message": "获取管道配置成功"
  }
  ```

## 3. 多项目技术栈测试

### 3.1 Java 项目测试
- **技术栈分析**: `POST /projects/1/analyze?path=test/java-project`
- **生成 CI 配置**: `POST /projects/1/generate-pipeline?path=test/java-project&platform=github`
- **预期 CI 配置**: Maven 构建和测试步骤

### 3.2 Node.js 项目测试
- **技术栈分析**: `POST /projects/1/analyze?path=test/nodejs-project`
- **生成 CI 配置**: `POST /projects/1/generate-pipeline?path=test/nodejs-project&platform=github`
- **预期 CI 配置**: npm 依赖安装、构建和测试步骤

### 3.3 Python 项目测试
- **技术栈分析**: `POST /projects/1/analyze?path=test/python-project`
- **生成 CI 配置**: `POST /projects/1/generate-pipeline?path=test/python-project&platform=github`
- **预期 CI 配置**: pip 依赖安装和 pytest 测试步骤

## 4. 详细测试命令与参数说明

### 4.1 项目管理接口

#### 4.1.1 创建项目
- **curl 命令**:
  ```bash
  curl -X POST http://localhost:8080/api/v1/projects \
    -H "Content-Type: application/json" \
    -d '{"name":"go-project","path":"test/go-project"}'
  ```
- **参数说明**:
  - `name`: 项目名称
  - `path`: 项目相对路径
- **预期响应**:
  ```json
  {
    "status": "success",
    "data": {},
    "message": "创建项目成功"
  }
  ```

#### 4.1.2 获取项目列表
- **curl 命令**:
  ```bash
  curl -X GET http://localhost:8080/api/v1/projects
  ```
- **参数说明**: 无
- **预期响应**:
  ```json
  {
    "status": "success",
    "data": [],
    "message": "获取项目列表成功"
  }
  ```

#### 4.1.3 获取项目详情
- **curl 命令**:
  ```bash
  curl -X GET http://localhost:8080/api/v1/projects/1
  ```
- **参数说明**:
  - `id`: 项目 ID (路径参数)
- **预期响应**:
  ```json
  {
    "status": "success",
    "data": {},
    "message": "获取项目详情成功"
  }
  ```

### 4.2 技术栈分析接口

#### 4.2.1 分析项目技术栈
- **curl 命令**:
  ```bash
  curl -X POST 'http://localhost:8080/api/v1/projects/1/analyze?path=test/go-project'
  ```
- **参数说明**:
  - `id`: 项目 ID (路径参数)
  - `path`: 项目相对路径 (查询参数)
- **预期响应**:
  ```json
  {
    "status": "success",
    "data": {
      "project_path": "test/go-project",
      "tech_stack": {
        "language": "Go",
        "framework": "",
        "build_tool": "go mod",
        "test_framework": "testing",
        "dependencies": {
          "github.com/gin-gonic/gin": "v1.9.0",
          "go": "1.20"
        },
        "files": []
      },
      "confidence": 0.8,
      "errors": []
    },
    "message": "分析项目技术栈成功"
  }
  ```

#### 4.2.2 获取项目技术栈
- **curl 命令**:
  ```bash
  curl -X GET 'http://localhost:8080/api/v1/projects/1/tech-stack?path=test/go-project'
  ```
- **参数说明**:
  - `id`: 项目 ID (路径参数)
  - `path`: 项目相对路径 (查询参数)
- **预期响应**:
  ```json
  {
    "status": "success",
    "data": {
      "language": "Go",
      "framework": "",
      "build_tool": "go mod",
      "test_framework": "testing",
      "dependencies": {
        "github.com/gin-gonic/gin": "v1.9.0",
        "go": "1.20"
      },
      "files": []
    },
    "message": "获取项目技术栈成功"
  }
  ```

### 4.3 CI/CD 管道配置接口

#### 4.3.1 生成管道配置 (GitHub Actions)
- **curl 命令**:
  ```bash
  curl -X POST 'http://localhost:8080/api/v1/projects/1/generate-pipeline?path=test/go-project&platform=github'
  ```
- **参数说明**:
  - `id`: 项目 ID (路径参数)
  - `path`: 项目相对路径 (查询参数)
  - `platform`: 目标平台，可选值: `github` (默认) 或 `mock`
- **预期响应**:
  ```json
  {
    "status": "success",
    "data": {
      "platform": "github_actions",
      "config_type": "yaml",
      "content": "name: CI\n\non:\n  push:\n    branches: [ main ]\n  pull_request:\n    branches: [ main ]\njobs:\n  build:\n    runs-on: ubuntu-latest\n    steps:\n    - uses: actions/checkout@v2\n    - name: Set up Go\n      uses: actions/setup-go@v2\n      with:\n        go-version: 1.20\n    - name: Build\n      run: go build -v ./...\n    - name: Test\n      run: go test -v ./...\n",
      "filename": ".github/workflows/ci.yml"
    },
    "message": "生成管道配置成功"
  }
  ```

#### 4.3.2 生成管道配置 (Mock)
- **curl 命令**:
  ```bash
  curl -X POST 'http://localhost:8080/api/v1/projects/1/generate-pipeline?path=test/go-project&platform=mock'
  ```
- **参数说明**:
  - `id`: 项目 ID (路径参数)
  - `path`: 项目相对路径 (查询参数)
  - `platform`: 目标平台，设置为 `mock`
- **预期响应**:
  ```json
  {
    "status": "success",
    "data": {
      "platform": "mock",
      "config_type": "yaml",
      "content": "name: Mock CI\n\non:\n  push:\n    branches: [ main ]\n\njobs:\n  build:\n    runs-on: mock-runner\n    steps:\n    - name: Mock checkout\n      run: echo \"Mock checkout step\"\n    - name: Mock build\n      run: echo \"Mock build step\"\n    - name: Mock test\n      run: echo \"Mock test step\"\n",
      "filename": "mock-ci.yml"
    },
    "message": "生成管道配置成功"
  }
  ```

#### 4.3.3 生成管道配置 (文件已存在)
- **curl 命令**:
  ```bash
  curl -X POST 'http://localhost:8080/api/v1/projects/1/generate-pipeline?path=test/go-project&platform=github'
  ```
- **参数说明**:
  - `id`: 项目 ID (路径参数)
  - `path`: 项目相对路径 (查询参数)
  - `platform`: 目标平台，可选值: `github` (默认) 或 `mock`
- **预期响应**:
  ```json
  {
    "status": "success",
    "data": {
      "platform": "github_actions",
      "config_type": "yaml",
      "content": "name: CI\n...",
      "filename": ".github/workflows/ci.yml"
    },
    "message": "配置文件已存在，跳过生成"
  }
  ```

#### 4.3.4 获取管道配置
- **curl 命令**:
  ```bash
  curl -X GET 'http://localhost:8080/api/v1/projects/1/pipeline'
  ```
- **参数说明**:
  - `id`: 项目 ID (路径参数)
- **预期响应**:
  ```json
  {
    "status": "success",
    "data": {
      "platform": "github_actions",
      "config_type": "yaml",
      "content": "name: CI\n...",
      "filename": ".github/workflows/ci.yml"
    },
    "message": "获取管道配置成功"
  }
  ```

### 4.4 多项目测试命令

#### 4.4.1 Java 项目测试
- **分析技术栈**:
  ```bash
  curl -X POST 'http://localhost:8080/api/v1/projects/1/analyze?path=test/java-project'
  ```
- **生成 CI 配置**:
  ```bash
  curl -X POST 'http://localhost:8080/api/v1/projects/1/generate-pipeline?path=test/java-project&platform=github'
  ```

#### 4.4.2 Node.js 项目测试
- **分析技术栈**:
  ```bash
  curl -X POST 'http://localhost:8080/api/v1/projects/1/analyze?path=test/nodejs-project'
  ```
- **生成 CI 配置**:
  ```bash
  curl -X POST 'http://localhost:8080/api/v1/projects/1/generate-pipeline?path=test/nodejs-project&platform=github'
  ```

#### 4.4.3 Python 项目测试
- **分析技术栈**:
  ```bash
  curl -X POST 'http://localhost:8080/api/v1/projects/1/analyze?path=test/python-project'
  ```
- **生成 CI 配置**:
  ```bash
  curl -X POST 'http://localhost:8080/api/v1/projects/1/generate-pipeline?path=test/python-project&platform=github'
  ```

## 5. 验证步骤

1. **服务器状态检查**: 确保 API 服务器运行在 `http://localhost:8080`
2. **接口调用**: 使用 curl 命令或 API 测试工具调用接口
3. **响应验证**: 检查接口返回的状态码和响应内容是否符合预期
4. **文件验证**: 检查生成的 CI 配置文件是否存在于项目目录中
5. **多项目测试**: 对所有测试项目执行相同的测试步骤

## 6. 预期结果

- 所有接口返回成功状态
- 技术栈分析能够正确识别不同项目的技术栈
- CI 配置生成能够根据不同技术栈生成对应的配置
- 配置文件能够正确写入到项目目录中
- 当配置文件已存在时，接口能够跳过生成过程

## 7. 故障排除

- **服务器未运行**: 执行 `go run cmd/server/main.go` 启动服务器
- **接口返回错误**: 检查请求 URL 和参数是否正确
- **文件未生成**: 检查项目路径是否正确，确保有写入权限
- **技术栈识别失败**: 检查项目目录结构是否完整，是否包含必要的配置文件