# CI/CD 管道管理系统文档

## 1. 系统概述

CI/CD 管道管理系统是一个用于自动化构建、测试和部署软件项目的平台。该系统能够分析项目技术栈，生成适合的 CI/CD 配置，并支持多平台执行。

### 1.1 主要功能

- **项目管理**：创建、查看、删除项目
- **技术栈分析**：自动识别项目的技术栈（语言、框架、构建工具等）
- **CI/CD 配置生成**：根据技术栈生成适合的 CI/CD 配置文件
- **模板管理**：管理 CI/CD 配置模板，支持内置模板和自定义模板
- **执行管理**：执行 CI/CD 管道，查看执行历史和指标
- **优化建议**：分析执行数据，生成优化建议

### 1.2 支持的平台

- **GitHub Actions**：真实的 CI/CD 平台
- **Mock**：模拟的 CI/CD 平台，用于测试和开发

## 2. 系统架构

### 2.1 后端架构

- **语言**：Go
- **数据库**：SQLite
- **API**：RESTful API

### 2.2 前端架构

- **框架**：Vue 3
- **构建工具**：Vite
- **HTTP 客户端**：Axios

### 2.3 前端导航

- **导航栏**：包含系统标题和主要功能选项卡
- **功能选项卡**：项目管理、模板管理、使用指南
- **回到上一页**：提供返回按钮，方便用户在不同页面间导航
- **响应式设计**：适配不同屏幕尺寸

### 2.4 核心模块

1. **项目管理模块**：处理项目的 CRUD 操作
2. **技术栈分析模块**：识别项目的技术栈
3. **CI/CD 配置生成模块**：根据技术栈生成配置
4. **模板管理模块**：管理 CI/CD 配置模板
5. **执行管理模块**：执行 CI/CD 管道
6. **指标分析模块**：分析执行指标
7. **优化建议模块**：生成优化建议

## 3. 安装与部署

### 3.1 后端部署

1. **环境要求**：
   - Go 1.20+
   - SQLite 3+

2. **启动步骤**：
   ```bash
   # 克隆代码库
   git clone <repository-url>
   cd <repository-directory>

   # 安装依赖
   go mod tidy

   # 启动服务器
   go run cmd/server/main.go
   ```

   服务器默认启动在 `http://localhost:8080`

### 3.2 前端部署

1. **环境要求**：
   - Node.js 16+
   - npm 7+

2. **启动步骤**：
   ```bash
   # 进入前端目录
   cd frontend

   # 安装依赖
   npm install

   # 启动开发服务器
   npm run dev
   ```

   前端开发服务器默认启动在 `http://localhost:3000`

3. **构建生产版本**：
   ```bash
   # 构建生产版本
   npm run build

   # 部署 dist 目录到 Web 服务器
   ```

## 4. API 接口

### 4.1 项目管理

- **GET /api/v1/projects**：获取项目列表
- **POST /api/v1/projects**：创建新项目
- **GET /api/v1/projects/{id}**：获取项目详情
- **PUT /api/v1/projects/{id}**：更新项目
- **DELETE /api/v1/projects/{id}**：删除项目

### 4.2 技术栈分析

- **POST /api/v1/projects/{id}/analyze**：分析项目技术栈
- **GET /api/v1/projects/{id}/tech-stack**：获取技术栈分析结果

### 4.3 CI/CD 配置生成

- **POST /api/v1/projects/{id}/generate-pipeline**：生成管道配置
  - 参数：
    - `platform`：平台类型（github_actions 或 mock）
    - `path`：项目路径
    - `template_id`：模板ID（可选）

### 4.4 模板管理

- **GET /api/v1/templates**：获取模板列表
- **POST /api/v1/templates**：创建新模板
- **GET /api/v1/templates/{id}**：获取模板详情
- **PUT /api/v1/templates/{id}**：更新模板
- **DELETE /api/v1/templates/{id}**：删除模板
- **POST /api/v1/templates/{id}/reset**：重置内置模板

### 4.5 执行管理

- **POST /api/v1/projects/{id}/execute**：执行管道
  - 参数：
    - `platform`：平台类型（github_actions 或 mock）
- **GET /api/v1/projects/{id}/executions**：获取执行历史
- **GET /api/v1/executions/{id}**：获取执行详情
- **POST /api/v1/executions/{id}/stop**：停止执行
- **GET /api/v1/executions/{id}/metrics**：获取执行指标
- **GET /api/v1/executions/{id}/logs**：获取执行日志

### 4.6 指标分析

- **GET /api/v1/projects/{id}/metrics**：获取项目指标

### 4.7 优化建议

- **POST /api/v1/projects/{id}/analyze-optimization**：分析优化建议
- **GET /api/v1/projects/{id}/optimization-suggestions**：获取优化建议

## 5. 使用指南

### 5.1 项目管理

1. **创建项目**：
   - 在前端界面的"项目管理"页面，填写项目名称和路径
   - 点击"创建项目"按钮

2. **分析技术栈**：
   - 在项目列表中，找到要分析的项目
   - 点击"分析技术栈"按钮
   - 系统会自动识别项目的技术栈
   - 分析完成后，系统会显示详细的技术栈分析结果，包括：
     - **编程语言**：项目使用的主要编程语言
     - **框架**：项目使用的框架（如适用）
     - **构建工具**：项目使用的构建工具（如适用）
     - **测试框架**：项目使用的测试框架（如适用）
     - **依赖包**：项目使用的依赖包及其版本

3. **生成管道配置**：
   - 在项目列表中，找到要生成配置的项目
   - 点击"生成管道"按钮
   - 在弹出的对话框中，选择平台（GitHub Actions 或 Mock）
   - 选择要使用的模板：
     - **默认模板**：根据项目技术栈自动选择最匹配的模板
     - **内置模板**：系统预设的模板，适用于常见的技术栈
     - **自定义模板**：用户创建的模板，适用于特定项目的需求
   - 点击"确定"按钮
   - 系统会根据技术栈和选择的模板生成配置文件
   - 配置文件会保存在项目目录的对应路径中（GitHub Actions 为 .github/workflows/ci.yml，Mock 为 .mock/workflows/ci.yaml）

4. **执行管道**：
   - 在项目列表中，找到要执行的项目
   - 点击"执行管道"按钮
   - 在弹出的对话框中，选择平台（GitHub Actions 或 Mock）
   - 点击"确定"按钮
   - 系统会执行 CI/CD 管道

5. **查看执行历史**：
   - 在项目列表中，找到要查看的项目
   - 点击"查看执行"按钮
   - 系统会显示该项目的执行历史

6. **分析优化建议**：
   - 在项目列表中，找到要分析的项目
   - 点击"分析优化"按钮
   - 系统会分析执行数据，生成优化建议

### 5.2 模板管理

1. **查看模板列表**：
   - 在前端界面的"模板管理"页面，系统会显示所有模板
   - 模板分为内置模板和自定义模板

2. **创建模板**：
   - 在"模板管理"页面，填写模板信息：
     - 平台：选择 GitHub Actions 或 Mock
     - 语言：填写项目的编程语言
     - 框架：填写项目使用的框架
     - 文件名：填写配置文件的路径
     - 配置类型：选择 YAML 或 JSON
     - 内容：填写模板的具体内容
   - 点击"创建模板"按钮

3. **编辑模板**：
   - 在模板列表中，找到要编辑的模板
   - 点击"编辑"按钮
   - 修改模板信息
   - 点击"更新模板"按钮

4. **删除模板**：
   - 在模板列表中，找到要删除的模板
   - 点击"删除"按钮
   - 确认删除操作

5. **重置内置模板**：
   - 在模板列表中，找到要重置的内置模板
   - 点击"重置"按钮
   - 系统会将模板恢复到默认状态

## 6. 模板系统

### 6.1 模板类型

1. **内置模板**：系统预设的模板，适用于常见的技术栈
2. **自定义模板**：用户创建的模板，适用于特定项目的需求

### 6.2 模板路径

- **GitHub Actions 模板**：存储在 `.github/workflows/ci.yml`
- **Mock 模板**：存储在 `.mock/workflows/ci.yaml`

### 6.3 模板选择逻辑

当生成管道配置时，系统会按照以下优先级选择模板：

1. **用户指定模板**：如果用户在生成配置时选择了特定模板，系统会直接使用该模板
2. **语言 + 框架 + 平台**：根据项目的语言、框架和平台选择最匹配的模板
3. **语言 + 平台**：根据项目的语言和平台选择匹配的模板
4. **平台默认模板**：使用平台的默认模板

### 6.4 内置模板自动初始化

系统在启动时会自动初始化内置模板，包括：

- **GitHub Actions 模板**：适用于 Go、Java、Python、JavaScript 等常见语言的模板
- **Mock 平台模板**：适用于测试和开发的模拟执行模板

内置模板会自动存储到数据库中，用户可以在模板管理页面查看和使用这些模板。如果内置模板被修改，用户可以通过"重置内置模板"功能将其恢复到默认状态。

## 7. 执行系统

### 7.1 GitHub Actions 平台

- **配置生成**：生成 GitHub Actions 配置文件
- **支持范围**：目前仅支持生成配置文件，不支持执行 workflow 等功能
- **配置路径**：生成的配置文件保存在 `.github/workflows/ci.yml`
- **注意**：GitHub Actions 的实际执行需要在 GitHub 平台上进行，本系统仅负责生成配置文件

### 7.2 Mock 平台

- **模拟执行**：模拟 CI/CD 管道的执行过程，支持分步执行
- **分步执行**：执行每个 job 中的多个 step，每个 step 都有独立的执行日志和状态
- **指标收集**：收集执行时长、成功率、CPU/内存使用率等指标
- **执行跟踪**：跟踪执行状态和进度，包括每个 step 的执行情况
- **日志记录**：记录详细的执行日志，包括 step 级别的日志信息
- **资源配置**：支持在配置文件中设置 CPU 和内存的 requests 和 limits，系统会模拟资源使用情况

## 8. 指标与优化

### 8.1 收集的指标

- **执行时长**：管道执行的总时长
- **成功率**：管道执行的成功比例
- **CPU 使用率**：执行过程中的 CPU 使用情况
- **内存使用率**：执行过程中的内存使用情况

### 8.2 优化建议

系统会根据历史执行数据，分析管道中的瓶颈，并生成优化建议，例如：

- **资源优化**：根据实际使用情况，调整 CPU 和内存的请求与限制
- **步骤优化**：分析执行步骤的耗时，识别瓶颈步骤
- **并行执行**：建议将可以并行执行的步骤改为并行执行

## 9. 故障排查

### 9.1 常见问题

1. **API 调用失败**：
   - 检查服务器是否正在运行
   - 检查网络连接是否正常
   - 检查 API 路径是否正确

2. **技术栈分析失败**：
   - 检查项目路径是否正确
   - 检查项目是否存在
   - 检查项目是否有明显的技术栈特征文件

3. **生成配置失败**：
   - 检查项目技术栈是否已分析
   - 检查模板是否存在
   - 检查项目路径是否正确

4. **执行管道失败**：
   - 检查平台配置是否正确
   - 检查项目是否有 CI/CD 配置文件
   - 检查执行权限是否正确

### 9.2 日志查看

- **后端日志**：在启动服务器的终端中查看
- **前端日志**：在浏览器的开发者工具中查看
- **执行日志**：在"执行管理"页面，点击"查看日志"按钮

## 10. 系统扩展

### 10.1 添加新平台

1. **实现平台适配器**：
   - 在 `internal/cicd/adapter` 目录下，创建新的平台适配器
   - 实现 `Adapter` 接口

2. **注册平台**：
   - 在 `cmd/server/main.go` 中，注册新平台

3. **添加模板**：
   - 在 `internal/cicd/template/manager.go` 中，添加新平台的默认模板

### 10.2 添加新模板

1. **创建模板**：
   - 在前端界面的"模板管理"页面，创建新模板
   - 填写模板信息和内容

2. **使用模板**：
   - 在生成管道配置时，选择新创建的模板

### 10.3 扩展技术栈识别

1. **添加新的技术栈检测器**：
   - 在 `internal/techstack/detector` 目录下，创建新的检测器
   - 实现 `Detector` 接口

2. **注册检测器**：
   - 在 `internal/techstack/techstack.go` 中，注册新检测器

## 11. 安全考虑

### 11.1 注意事项

- **API 安全**：确保 API 接口有适当的认证和授权机制
- **文件系统访问**：确保系统只访问授权的文件和目录
- **命令执行**：确保系统执行的命令是安全的，避免命令注入攻击
- **数据验证**：确保所有输入数据都经过验证，避免注入攻击

### 11.2 最佳实践

- **最小权限原则**：系统只拥有完成任务所需的最小权限
- **输入验证**：对所有用户输入进行验证
- **输出编码**：对所有输出进行适当的编码
- **日志记录**：记录系统的关键操作和错误
- **定期更新**：定期更新系统依赖，修复安全漏洞

## 12. 性能优化

### 12.1 后端优化

- **缓存**：对频繁访问的数据进行缓存
- **并发处理**：使用并发处理提高性能
- **数据库优化**：优化数据库查询，使用索引
- **资源管理**：合理管理系统资源，避免资源泄漏

### 12.2 前端优化

- **懒加载**：对非关键资源进行懒加载
- **缓存**：缓存静态资源
- **代码分割**：将代码分割成小块，减少初始加载时间
- **优化渲染**：减少 DOM 操作，优化渲染性能

## 13. 总结

CI/CD 管道管理系统是一个功能强大的工具，能够帮助开发团队自动化构建、测试和部署软件项目。通过技术栈分析、模板管理和执行跟踪等功能，系统能够为不同类型的项目生成适合的 CI/CD 配置，并提供优化建议，提高开发效率和代码质量。

系统的模块化设计和可扩展架构，使得它能够适应不同项目的需求，并且可以通过添加新平台、新模板和新技术栈识别器来扩展功能。

通过使用 CI/CD 管道管理系统，开发团队可以：
- 减少手动操作，提高自动化程度
- 更早地发现和修复问题
- 加快部署速度，缩短发布周期
- 提高代码质量和系统稳定性

## 14. 附录

### 14.1 技术栈识别支持

- **语言**：Go、Java、JavaScript、Python、C++、C# 等
- **框架**：React、Vue、Angular、Spring、Django、Flask 等
- **构建工具**：Maven、Gradle、npm、yarn、pip 等

### 14.2 配置文件示例

#### GitHub Actions 配置示例（Go 项目）：

```yaml
name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
jobs:
  build:
    runs-on: ubuntu-latest
    # 资源配置
    resources:
      limits:
        cpu: 2
        memory: 4G
      requests:
        cpu: 1
        memory: 2G
    steps:
    - uses: actions/checkout@v2
    - name: Set up Go
      uses: actions/setup-go@v2
      with:
        go-version: 1.20
    - name: Build
      run: go build -v ./...
    - name: Test
      run: go test -v ./...
```

#### Mock 平台配置示例：

```yaml
name: Mock CI

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: mock-runner
    # 资源配置
    resources:
      limits:
        cpu: 2
        memory: 4G
      requests:
        cpu: 1
        memory: 2G
    steps:
    - name: Mock checkout
      run: echo "Mock checkout step"
    - name: Mock build
      run: echo "Mock build step"
    - name: Mock test
      run: echo "Mock test step"
```

### 14.3 故障排查流程图

1. **API 调用失败**：
   - 检查服务器状态 → 检查网络连接 → 检查 API 路径 → 查看服务器日志 → 修复问题

2. **技术栈分析失败**：
   - 检查项目路径 → 检查项目文件 → 查看服务器日志 → 修复问题

3. **生成配置失败**：
   - 检查技术栈分析结果 → 检查模板状态 → 查看服务器日志 → 修复问题

4. **执行管道失败**：
   - 检查平台配置 → 检查配置文件 → 查看执行日志 → 修复问题

## 15. 版本历史

| 版本 | 日期 | 描述 |
|------|------|------|
| 1.0.0 | 2026-02-12 | 初始版本 |
| 1.1.0 | 2026-02-12 | 添加模板选择功能 |
| 1.2.0 | 2026-02-12 | 优化前端界面，添加回到上一页功能 |